import{g as lt,J as ct,r as u,j as t,B as U}from"./index-4ee0f0da.js";import{I as w}from"./input-8ed76811.js";import{L as S}from"./label-7b69399a.js";import{D as W}from"./date-picker-2abee23a.js";import{S as F,a as A,b as C,c as T,d as V}from"./select-5d8a578c.js";import{T as ut}from"./textarea-ca32e632.js";import{C as mt,a as pt,b as xt,c as bt,d as ht}from"./card-0b571230.js";import{P as gt}from"./package-plus-dfaeccf5.js";import{T as yt}from"./trash-2-0a9625ce.js";import{P as ft}from"./plus-circle-a4a328b1.js";import{S as K}from"./save-83bb6635.js";import"./check-6bd3e78d.js";const O=()=>{const x=localStorage.getItem("products");if(x)try{return JSON.parse(x).map(s=>{var I;return{...s,units:((I=s.units)==null?void 0:I.map(k=>({...k,id:k.id||`${s.id}-${k.name}-${Date.now()}`})))||[],openingQuantity:s.isService?1/0:s.openingQuantity||0}})}catch(P){return console.error("Failed to parse products from localStorage",P),[]}return[{id:"PROD001",name:"Standard Widget",costingPrice:15.5,openingQuantity:100,isService:!1,units:[{id:`PROD001-pcs-${Date.now()}`,name:"pcs",factor:1,isBase:!0},{id:`PROD001-dozen-${Date.now()}`,name:"dozen",factor:12,isBase:!1}],baseUnitName:"pcs"}]},It=()=>{const x=localStorage.getItem("vendors");return x?JSON.parse(x):[]},Ct=()=>{const{toast:x}=lt(),P=ct(),{purchaseOrder:s}=P.state||{},[I,k]=u.useState((s==null?void 0:s.vendor)||""),[E,X]=u.useState(s!=null&&s.orderDate?new Date(s.orderDate):new Date),[$,Y]=u.useState(s!=null&&s.expectedDeliveryDate?new Date(s.expectedDeliveryDate):new Date(new Date().setDate(new Date().getDate()+30))),[L,jt]=u.useState(`BILL-${String(Date.now()).slice(-6)}${s?"-PO"+s.orderNumber:""}`),[z,Z]=u.useState((s==null?void 0:s.memo)||(s==null?void 0:s.notes)||""),[Q,J]=u.useState([]),[_,tt]=u.useState([]);u.useEffect(()=>{if(J(O()),tt(It()),s){const a=s.lineItems.map(n=>{const i=O().find(d=>d.id===n.productId);return{id:Date.now()+Math.random(),productId:n.productId,productDetails:i,quantityInput:n.quantityInput,quantityUnitId:n.quantityUnitId,quantityInBase:n.quantityUnitFactor?n.quantityInput*n.quantityUnitFactor:n.quantityInput,billingUnitId:n.billingUnitId,rateForBillingUnit:n.rateForBillingUnit,discountPercent:n.discountPercent||0,discountAmount:n.discountAmount||0,totalPrice:n.totalPrice}});q(a)}},[s]);const[b,q]=u.useState([{id:Date.now(),productId:"",productDetails:null,quantityInput:1,quantityUnitId:"",quantityInBase:1,billingUnitId:"",rateForBillingUnit:0,discountPercent:0,discountAmount:0,totalPrice:0}]),[R,et]=u.useState(0),[at,nt]=u.useState("$0.00"),[N,rt]=u.useState(0),[st,it]=u.useState(0),j=u.useCallback(a=>{let n=parseFloat(a.quantityInput)||0;if(a.productDetails&&a.quantityUnitId&&a.productDetails.units){const e=a.productDetails.units.find(m=>m.id===a.quantityUnitId);e&&e.factor>0&&(n=(parseFloat(a.quantityInput)||0)*e.factor)}let i=0;if(a.productDetails&&a.billingUnitId&&a.productDetails.units){const e=a.productDetails.units.find(m=>m.id===a.billingUnitId);if(e&&e.factor>0){const m=(parseFloat(a.rateForBillingUnit)||0)/e.factor;i=n*m}}let d=0;parseFloat(a.discountAmount)>0?d=parseFloat(a.discountAmount):parseFloat(a.discountPercent)>0&&(d=i*(parseFloat(a.discountPercent)/100));const l=parseFloat((i-d).toFixed(2));return{...a,quantityInBase:n,totalPrice:l,itemRawTotal:i}},[]);u.useEffect(()=>{let a=0,n=0;b.map(d=>j(d)).forEach(d=>{a+=d.itemRawTotal||0,d.discountAmount>0?n+=d.discountAmount:d.discountPercent>0&&(n+=(d.itemRawTotal||0)*(d.discountPercent/100))}),et(parseFloat(a.toFixed(2))),nt(`-${n.toLocaleString("en-US",{style:"currency",currency:"USD"})}`)},[b,j]),u.useEffect(()=>{const a=b.reduce((i,d)=>{const l=j(d);let e=0;return l.discountAmount>0?e=l.discountAmount:l.discountPercent>0&&(e=(l.itemRawTotal||0)*(l.discountPercent/100)),i+e},0),n=R-a+N;it(parseFloat(n.toFixed(2)))},[R,N,b,j]);const dt=()=>{q([...b,{id:Date.now(),productId:"",productDetails:null,quantityInput:1,quantityUnitId:"",quantityInBase:1,billingUnitId:"",rateForBillingUnit:0,discountPercent:0,discountAmount:0,totalPrice:0}])},ot=a=>{q(b.filter(n=>n.id!==a))},y=(a,n,i)=>{q(d=>d.map(l=>{var r,c,h,v,D;if(l.id!==a)return l;let e={...l};if(n==="productId"){const o=Q.find(p=>p.id===i);if(o){e.productId=i,e.productDetails=o;const p=(r=o.units)==null?void 0:r.find(g=>g.isBase);if(e.quantityUnitId=p?p.id:((h=(c=o.units)==null?void 0:c[0])==null?void 0:h.id)||"",e.billingUnitId=p?p.id:((D=(v=o.units)==null?void 0:v[0])==null?void 0:D.id)||"",p&&o.costingPrice){const g=o.units.find(B=>B.id===e.billingUnitId);e.rateForBillingUnit=(o.costingPrice||0)*((g==null?void 0:g.factor)||1)}else e.rateForBillingUnit=0;e.quantityInput=1}else e={...e,productId:"",productDetails:null,quantityUnitId:"",billingUnitId:"",rateForBillingUnit:0,quantityInput:1}}else if(n==="quantityUnitId"||n==="billingUnitId")e[n]=i;else if(n==="quantityInput")e.quantityInput=parseFloat(i)>=0?parseFloat(i):0;else if(n==="rateForBillingUnit")e[n]=parseFloat(i)||0;else if(n==="discountPercent"){const o=parseFloat(i)||0;e.discountPercent=o,o>0&&(e.discountAmount=0)}else if(n==="discountAmount"){const o=parseFloat(i)||0;e.discountAmount=o,o>0&&(e.discountPercent=0)}else e[n]=i;let m=parseFloat(e.quantityInput)||0;if(e.productDetails&&e.quantityUnitId&&e.productDetails.units){const o=e.productDetails.units.find(p=>p.id===e.quantityUnitId);o&&o.factor>0&&(m=(parseFloat(e.quantityInput)||0)*o.factor)}return e.quantityInBase=m,j(e)}))},G=(a=!1)=>{if(!I){x({title:"Validation Error",description:"Please select a vendor.",variant:"destructive"});return}if(b.some(r=>!r.productId||r.totalPrice===0&&r.quantityInput>0)){x({title:"Validation Error",description:"Please ensure all line items have a product, valid quantity, units, and rate leading to a price.",variant:"destructive"});return}if(b.length===0||b.every(r=>r.quantityInput===0)){x({title:"Validation Error",description:"Cannot save an empty bill or a bill with all zero quantities.",variant:"destructive"});return}const n=b.filter(r=>r.quantityInput>0).map(r=>j(r));if(n.length===0){x({title:"Validation Error",description:"Cannot save a bill with no valid line items.",variant:"destructive"});return}const i=n.reduce((r,c)=>r+(c.itemRawTotal||0),0),d=n.reduce((r,c)=>{let h=0;return c.discountAmount>0?h=c.discountAmount:c.discountPercent>0&&(h=(c.itemRawTotal||0)*(c.discountPercent/100)),r+h},0),l={vendor:I,billNumber:L,billDate:E,dueDate:$,purchaseOrderId:(s==null?void 0:s.orderNumber)||null,lineItems:n.map(r=>{var c,h,v,D,o,p,g,B,H,M;return{productId:r.productId,productName:(c=r.productDetails)==null?void 0:c.name,quantityInput:r.quantityInput,quantityUnitId:r.quantityUnitId,quantityUnitName:(v=(h=r.productDetails)==null?void 0:h.units.find(f=>f.id===r.quantityUnitId))==null?void 0:v.name,quantityUnitFactor:(o=(D=r.productDetails)==null?void 0:D.units.find(f=>f.id===r.quantityUnitId))==null?void 0:o.factor,calculatedQuantityInBase:r.quantityInBase,baseUnitName:(p=r.productDetails)==null?void 0:p.baseUnitName,billingUnitId:r.billingUnitId,billingUnitName:(B=(g=r.productDetails)==null?void 0:g.units.find(f=>f.id===r.billingUnitId))==null?void 0:B.name,billingUnitFactor:(M=(H=r.productDetails)==null?void 0:H.units.find(f=>f.id===r.billingUnitId))==null?void 0:M.factor,rateForBillingUnit:r.rateForBillingUnit,discountPercent:r.discountPercent,discountAmount:r.discountAmount,itemRawTotal:r.itemRawTotal,calculatedPrice:r.totalPrice}}),subtotal:i,totalDiscount:d,taxAmount:N,grandTotal:i-d+N,notes:z,isDraft:a};console.log("Purchase Bill Data: ",JSON.stringify(l,null,2));const e=JSON.parse(localStorage.getItem("purchaseBills")||"[]");localStorage.setItem("purchaseBills",JSON.stringify([...e,l]));const m=Q.map(r=>{const c=l.lineItems.find(h=>h.productId===r.id);return c&&r.openingQuantity!==1/0?{...r,openingQuantity:r.openingQuantity+c.calculatedQuantityInBase}:r});localStorage.setItem("products",JSON.stringify(m)),J(m),x({title:"Purchase Bill Saved",description:`Bill ${L} has been ${a?"saved as draft":"saved"}. Stock updated.`,className:"bg-green-100 dark:bg-green-800 text-green-700 dark:text-green-200 border-green-300 dark:border-green-600"})};return t.jsx("div",{className:"space-y-6 p-1 md:p-2",children:t.jsxs(mt,{className:"shadow-xl border-border dark:border-dark-border bg-card dark:bg-dark-card",children:[t.jsx(pt,{className:"p-6 border-b border-border dark:border-dark-border",children:t.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[t.jsxs(xt,{className:"text-3xl font-bold text-primary dark:text-dark-primary flex items-center",children:[t.jsx(gt,{size:32,className:"mr-3 text-accent dark:text-dark-accent"})," New Purchase Bill"]}),t.jsx("div",{className:"text-muted-foreground dark:text-dark-muted-foreground font-mono text-sm bg-muted dark:bg-dark-muted px-2 py-1 rounded self-start sm:self-center",children:L})]})}),t.jsxs(bt,{className:"p-6 space-y-8",children:[t.jsxs("div",{className:"grid md:grid-cols-3 gap-6",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsxs(S,{htmlFor:"vendor",className:"font-semibold",children:["Vendor ",t.jsx("span",{className:"text-destructive dark:text-red-400",children:"*"})]}),t.jsxs(F,{onValueChange:k,value:I,disabled:!!s,children:[t.jsx(A,{id:"vendor",children:t.jsx(C,{placeholder:"Select vendor"})}),t.jsx(T,{children:_.map(a=>t.jsx(V,{value:a.id,children:a.name},a.id))})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(S,{htmlFor:"billDate",className:"font-semibold",children:"Bill Date"}),t.jsx(W,{date:E,setDate:X})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(S,{htmlFor:"dueDate",className:"font-semibold",children:"Due Date"}),t.jsx(W,{date:$,setDate:Y})]})]}),t.jsxs("div",{className:"overflow-x-auto bg-background dark:bg-dark-background p-4 rounded-lg border border-border dark:border-dark-border shadow-inner",children:[t.jsxs("table",{className:"w-full min-w-[1300px]",children:[t.jsx("thead",{className:"border-b-2 border-primary dark:border-dark-primary",children:t.jsxs("tr",{children:[t.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[18%]",children:"Product/Service"}),t.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[7%]",children:"Quantity"}),t.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[9%]",children:"Qty Unit"}),t.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[11%]",children:"Rate (Billing Unit)"}),t.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[11%]",children:"Billing Unit"}),t.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[7%]",children:"Disc (%)"}),t.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[9%]",children:"Disc Amt"}),t.jsx("th",{className:"p-3 text-right text-sm font-semibold text-primary dark:text-dark-primary w-[13%]",children:"Total Price"}),t.jsx("th",{className:"p-3 text-center text-sm font-semibold text-primary dark:text-dark-primary w-[5%]"})]})}),t.jsx("tbody",{children:b.map(a=>{var n,i,d,l;return t.jsxs("tr",{className:"border-b border-border dark:border-dark-border last:border-b-0 hover:bg-muted/50 dark:hover:bg-dark-muted/50 transition-colors",children:[t.jsx("td",{className:"p-2",children:t.jsxs(F,{value:a.productId,onValueChange:e=>y(a.id,"productId",e),children:[t.jsx(A,{className:"text-sm",children:t.jsx(C,{placeholder:"Select product"})}),t.jsx(T,{children:Q.map(e=>t.jsx(V,{value:e.id,children:e.name},e.id))})]})}),t.jsx("td",{className:"p-2",children:t.jsx(w,{type:"number",value:a.quantityInput,onChange:e=>y(a.id,"quantityInput",e.target.value),placeholder:"1",className:"w-full text-sm",min:"0",step:"any"})}),t.jsx("td",{className:"p-2",children:t.jsxs(F,{value:a.quantityUnitId,onValueChange:e=>y(a.id,"quantityUnitId",e),disabled:!a.productDetails,children:[t.jsx(A,{className:"text-sm",children:t.jsx(C,{placeholder:"Unit"})}),t.jsx(T,{children:(i=(n=a.productDetails)==null?void 0:n.units)==null?void 0:i.map(e=>t.jsx(V,{value:e.id,children:e.name},e.id))})]})}),t.jsx("td",{className:"p-2",children:t.jsx(w,{type:"number",value:a.rateForBillingUnit,onChange:e=>y(a.id,"rateForBillingUnit",e.target.value),placeholder:"0.00",className:"w-full text-sm",min:"0",step:"0.01"})}),t.jsx("td",{className:"p-2",children:t.jsxs(F,{value:a.billingUnitId,onValueChange:e=>y(a.id,"billingUnitId",e),disabled:!a.productDetails,children:[t.jsx(A,{className:"text-sm",children:t.jsx(C,{placeholder:"Unit"})}),t.jsx(T,{children:(l=(d=a.productDetails)==null?void 0:d.units)==null?void 0:l.map(e=>{var m;return t.jsxs(V,{value:e.id,children:[e.name," (",e.factor," ",(m=a.productDetails)==null?void 0:m.baseUnitName,")"]},e.id)})})]})}),t.jsx("td",{className:"p-2",children:t.jsx(w,{type:"number",value:a.discountPercent,onChange:e=>y(a.id,"discountPercent",e.target.value),placeholder:"0",className:"w-full text-sm",min:"0",max:"100",disabled:!!a.discountAmount&&a.discountAmount>0})}),t.jsx("td",{className:"p-2",children:t.jsx(w,{type:"number",value:a.discountAmount,onChange:e=>y(a.id,"discountAmount",e.target.value),placeholder:"0.00",className:"w-full text-sm",min:"0",step:"0.01",disabled:!!a.discountPercent&&a.discountPercent>0})}),t.jsx("td",{className:"p-2 text-right text-sm font-medium",children:(a.totalPrice||0).toLocaleString("en-US",{style:"currency",currency:"USD"})}),t.jsx("td",{className:"p-2 text-center",children:t.jsx(U,{variant:"ghost",size:"icon",onClick:()=>ot(a.id),className:"text-destructive dark:text-red-400 hover:text-destructive/80 h-8 w-8",children:t.jsx(yt,{size:16})})})]},a.id)})})]}),t.jsxs(U,{onClick:dt,variant:"outline",className:"mt-4 text-accent dark:text-dark-accent border-accent dark:border-dark-accent hover:bg-accent/10 dark:hover:bg-dark-accent/10 shadow-sm",children:[t.jsx(ft,{size:18,className:"mr-2"})," Add Line Item"]})]}),t.jsxs("div",{className:"grid md:grid-cols-2 gap-6 items-start",children:[t.jsxs("div",{children:[t.jsx(S,{htmlFor:"notes",className:"font-semibold",children:"Notes/Remarks"}),t.jsx(ut,{id:"notes",value:z,onChange:a=>Z(a.target.value),placeholder:"Enter any notes or remarks for this bill...",className:"mt-1 min-h-[100px]"})]}),t.jsxs("div",{className:"space-y-3 p-4 bg-muted/70 dark:bg-dark-muted/70 rounded-lg shadow-inner border border-border dark:border-dark-border",children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{className:"font-medium",children:"Subtotal:"}),t.jsx("span",{className:"font-semibold",children:R.toLocaleString("en-US",{style:"currency",currency:"USD"})})]}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{className:"font-medium",children:"Total Discount:"}),t.jsx("span",{className:"font-semibold text-green-600 dark:text-green-400",children:at})]}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx(S,{htmlFor:"taxAmountBill",className:"font-medium",children:"Tax (% or Amount):"}),t.jsx(w,{id:"taxAmountBill",type:"number",value:N,onChange:a=>rt(parseFloat(a.target.value)||0),placeholder:"0.00",className:"w-28 text-sm text-right",min:"0",step:"0.01"})]}),t.jsx("hr",{className:"border-border dark:border-dark-border my-2"}),t.jsxs("div",{className:"flex justify-between items-center text-xl text-primary dark:text-dark-primary font-bold",children:[t.jsx("span",{children:"Grand Total:"}),t.jsx("span",{children:st.toLocaleString("en-US",{style:"currency",currency:"USD"})})]})]})]})]}),t.jsxs(ht,{className:"bg-muted/30 dark:bg-dark-muted/30 rounded-b-lg p-6 flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-3 border-t border-border dark:border-dark-border",children:[t.jsx(U,{variant:"outline",className:"w-full sm:w-auto",onClick:()=>{},children:"Cancel"}),t.jsxs(U,{className:"w-full sm:w-auto bg-secondary text-secondary-foreground hover:bg-secondary-hover dark:bg-dark-secondary dark:text-dark-secondary-foreground dark:hover:bg-dark-secondary-hover flex items-center shadow hover:shadow-md",onClick:()=>G(!0),children:[t.jsx(K,{size:18,className:"mr-2"})," Save as Draft"]}),t.jsxs(U,{className:"w-full sm:w-auto bg-primary text-primary-foreground hover:bg-primary-hover dark:bg-dark-primary dark:text-dark-primary-foreground dark:hover:bg-dark-primary-hover flex items-center shadow hover:shadow-md",onClick:()=>G(!1),children:[t.jsx(K,{size:18,className:"mr-2"})," Save Bill"]})]})]})})};export{Ct as default};
