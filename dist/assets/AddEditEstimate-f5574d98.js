import{g as se,J as ie,i as re,r as p,j as e,B}from"./index-5883662f.js";import{C as ne,a as de,b as le,c as oe}from"./card-b1098844.js";import{I as z}from"./input-f36c83b8.js";import{L as F}from"./label-f9fa13f4.js";import{D as K}from"./date-picker-15c6f767.js";import{T as ce,a as me,b as X,c as y,d as ue,e as b}from"./table-00d8f558.js";import{S as k,a as T,b as L,c as O,d as E}from"./select-40359b79.js";import{T as pe}from"./textarea-0ace4801.js";import{T as xe}from"./trash-2-903ad08e.js";import{P as ge}from"./plus-circle-434317f6.js";import"./format-f1fedb6d.js";import"./check-db131b4d.js";const Y=()=>{const m=localStorage.getItem("products");if(m)try{return JSON.parse(m).map(u=>{var d;return{...u,units:((d=u.units)==null?void 0:d.map(x=>({...x,id:x.id||`${u.id}-${x.name}-${Date.now()}`,factor:parseFloat(x.factor)||1})))||[],openingQuantity:u.isService?1/0:u.openingQuantity||0}})}catch(j){return console.error("Failed to parse products from localStorage",j),[]}return[{id:"PROD001",name:"Standard Widget",costingPrice:15.5,openingQuantity:100,isService:!1,units:[{id:`PROD001-pcs-${Date.now()}`,name:"pcs",factor:1,isBase:!0},{id:`PROD001-dozen-${Date.now()}`,name:"dozen",factor:12,isBase:!1}],baseUnitName:"pcs"}]},we=()=>{const{toast:m}=se(),{id:j}=ie(),u=re(),[d,x]=p.useState(()=>{const t=new Date,i=new Date;return i.setDate(t.getDate()+7),{estimateNumber:`EST-${String(Date.now()).slice(-6)}`,estimateDate:t,expiryDate:i}}),[N,R]=p.useState({name:"My Company Name",address:"123 Business Rd, City, Country",logo:""}),[I,v]=p.useState({id:"",name:"",address:""}),[Q,Z]=p.useState([]),[A,_]=p.useState([]);p.useEffect(()=>{_(Y());const t=JSON.parse(localStorage.getItem("customers")||"[]");if(Z(t),j){const s=JSON.parse(localStorage.getItem("estimates")||"[]").find(l=>l.id===j);s?(x({estimateNumber:s.estimateDetails.estimateNumber,estimateDate:new Date(s.estimateDetails.estimateDate),expiryDate:new Date(s.estimateDetails.expiryDate)}),R(s.myCompany),v(s.customer),U(s.lineItems.map(l=>({...l,productDetails:Y().find(n=>n.id===l.productId)||null}))),V(s.description||"")):(m({title:"Estimate Not Found",description:"The estimate you are trying to edit does not exist.",variant:"destructive"}),u("/sales/estimate"))}else x(()=>{const i=new Date,s=new Date;return s.setDate(i.getDate()+7),{estimateNumber:`EST-${String(Date.now()).slice(-6)}`,estimateDate:i,expiryDate:s}}),R({name:"My Company Name",address:"123 Business Rd, City, Country",logo:""}),v({id:"",name:"",address:""}),U([{id:Date.now(),productId:"",productDetails:null,quantityInput:1,quantityUnitId:"",billingUnitId:"",rateForBillingUnit:0,totalPrice:0}]),V("")},[j,u]);const[f,U]=p.useState([{id:Date.now(),productId:"",productDetails:null,quantityInput:1,quantityUnitId:"",billingUnitId:"",rateForBillingUnit:0,totalPrice:0}]),[J,V]=p.useState(""),ee=p.useCallback(t=>{let i=parseFloat(t.quantityInput)||0;if(t.productDetails&&t.quantityUnitId&&t.productDetails.units){const n=t.productDetails.units.find(a=>a.id===t.quantityUnitId);n&&n.factor>0&&(i=(parseFloat(t.quantityInput)||0)*n.factor)}let s=0;if(t.productDetails&&t.billingUnitId&&t.productDetails.units){const n=t.productDetails.units.find(a=>a.id===t.billingUnitId);if(n&&n.factor>0){const a=(parseFloat(t.rateForBillingUnit)||0)/n.factor;s=i*a}}const l=parseFloat(s.toFixed(2));return{...t,totalPrice:l,itemRawTotal:s}},[]),$=(t,i)=>{x(s=>({...s,[t]:i}))},S=(t,i,s)=>{U(l=>l.map(n=>{var g,r,C,w,q;if(n.id!==t)return n;let a={...n};if(i==="productId"){const o=A.find(c=>c.id===s);if(o){a.productId=s,a.productDetails=o;const c=(g=o.units)==null?void 0:g.find(h=>h.isBase);if(a.quantityUnitId=c?c.id:((C=(r=o.units)==null?void 0:r[0])==null?void 0:C.id)||"",a.billingUnitId=c?c.id:((q=(w=o.units)==null?void 0:w[0])==null?void 0:q.id)||"",c&&o.costingPrice){const h=o.units.find(P=>P.id===a.billingUnitId);a.rateForBillingUnit=(o.costingPrice||0)*((h==null?void 0:h.factor)||1)}else a.rateForBillingUnit=0;a.quantityInput=1}else a={...a,productId:"",productDetails:null,quantityUnitId:"",billingUnitId:"",rateForBillingUnit:0,quantityInput:1}}else i==="quantityUnitId"||i==="billingUnitId"?a[i]=s:i==="quantityInput"?a.quantityInput=parseFloat(s)>=0?parseFloat(s):0:i==="rateForBillingUnit"?a[i]=parseFloat(s)||0:a[i]=s;return ee(a)}))},te=()=>{U(t=>[...t,{id:Date.now(),productId:"",productDetails:null,quantityInput:1,quantityUnitId:"",billingUnitId:"",rateForBillingUnit:0,totalPrice:0}])},ae=t=>{U(f.filter(i=>i.id!==t))},H=f.reduce((t,i)=>t+(i.totalPrice||0),0),M=t=>{var a,g;if(!d.estimateNumber||!d.estimateDate||!d.expiryDate){m({title:"Validation Error",description:"Estimate Number, Date, and Expiry Date are required.",variant:"destructive"});return}if(!I.id){m({title:"Validation Error",description:"Please select a customer.",variant:"destructive"});return}if(f.some(r=>!r.productId||r.quantityInput===0)){m({title:"Validation Error",description:"Please ensure all line items have a product and valid quantity.",variant:"destructive"});return}if(f.length===0||f.every(r=>r.quantityInput===0)){m({title:"Validation Error",description:"Cannot save an empty estimate or an estimate with all zero quantities.",variant:"destructive"});return}const i=f.filter(r=>r.quantityInput>0),s={id:d.estimateNumber,estimateDetails:{...d,estimateDate:(a=d.estimateDate)==null?void 0:a.toISOString(),expiryDate:(g=d.expiryDate)==null?void 0:g.toISOString()},myCompany:N,customer:I,lineItems:i.map(r=>{var C,w,q,o,c,h,P,W,G;return{productId:r.productId,productName:(C=r.productDetails)==null?void 0:C.name,quantityInput:r.quantityInput,quantityUnitId:r.quantityUnitId,quantityUnitName:(q=(w=r.productDetails)==null?void 0:w.units.find(D=>D.id===r.quantityUnitId))==null?void 0:q.name,quantityUnitFactor:(c=(o=r.productDetails)==null?void 0:o.units.find(D=>D.id===r.quantityUnitId))==null?void 0:c.factor,billingUnitId:r.billingUnitId,billingUnitName:(P=(h=r.productDetails)==null?void 0:h.units.find(D=>D.id===r.billingUnitId))==null?void 0:P.name,billingUnitFactor:(G=(W=r.productDetails)==null?void 0:W.units.find(D=>D.id===r.billingUnitId))==null?void 0:G.factor,rateForBillingUnit:r.rateForBillingUnit,totalPrice:r.totalPrice}}),overallTotal:H,isDraft:t,description:J,createdAt:new Date().toISOString()},n=[...JSON.parse(localStorage.getItem("estimates")||"[]").filter(r=>r.id!==s.id),s];localStorage.setItem("estimates",JSON.stringify(n)),m({title:"Estimate Saved",description:`Estimate ${s.id} has been ${t?"saved as draft":"finalized"}.`,className:"bg-green-100 dark:bg-green-800 text-green-700 dark:text-green-200 border-green-300 dark:border-green-600"}),t||window.print(),u("/sales/estimate")};return e.jsx("div",{className:"space-y-6 p-1",children:e.jsxs(ne,{className:"shadow-lg border-border dark:border-dark-border",children:[e.jsx(de,{className:"bg-card dark:bg-dark-card rounded-t-lg p-4 md:p-6 border-b border-border dark:border-dark-border",children:e.jsx(le,{className:"text-2xl md:text-3xl font-bold text-primary dark:text-dark-primary",children:j?"Edit Estimate":"Create Estimate"})}),e.jsxs(oe,{className:"p-4 md:p-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-8",children:[e.jsxs("div",{children:[N.logo&&e.jsx("img",{src:N.logo,alt:"Company Logo",className:"h-16 mb-4"}),e.jsx("p",{className:"font-semibold text-lg",children:N.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:N.address})]}),e.jsxs("div",{className:"space-y-2 md:text-right",children:[e.jsxs("div",{children:[e.jsx(F,{htmlFor:"estimateNumber",className:"text-right md:text-left",children:"Estimate Number:"}),e.jsx(z,{id:"estimateNumber",value:d.estimateNumber,onChange:t=>$("estimateNumber",t.target.value),className:"md:text-right mt-1"})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"estimateDate",className:"text-right md:text-left",children:"Estimate Date:"}),e.jsx(K,{date:d.estimateDate,setDate:t=>$("estimateDate",t),id:"estimateDate",placeholder:"Select date",className:"w-full mt-1"})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"expiryDate",className:"text-right md:text-left",children:"Expiry Date:"}),e.jsx(K,{date:d.expiryDate,setDate:t=>$("expiryDate",t),id:"expiryDate",placeholder:"Select date",className:"w-full mt-1"})]})]})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h3",{className:"font-semibold text-lg mb-2",children:"Bill To:"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx(F,{htmlFor:"customerSelect",children:"Customer:"}),e.jsxs(k,{value:I.id||"",onValueChange:t=>{if(t==="placeholder")v({id:"",name:"",address:""});else{const i=Q.find(s=>s.id===t);v(i?{id:i.id,name:i.name,address:i.address||""}:{id:"",name:"",address:""})}},children:[e.jsx(T,{id:"customerSelect",className:"mt-1",children:e.jsx(L,{placeholder:"Select a customer"})}),e.jsxs(O,{children:[e.jsx(E,{value:"placeholder",children:"Select a customer"}),Q.map(t=>e.jsx(E,{value:t.id,children:t.name},t.id))]})]})]}),I.name&&e.jsxs("div",{className:"mt-2 p-3 border rounded-md bg-muted/50 dark:bg-dark-muted/50",children:[e.jsx("p",{className:"font-semibold",children:I.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:I.address})]})]})]}),e.jsx("div",{className:"overflow-x-auto rounded-lg border border-border dark:border-dark-border shadow-md mb-8",children:e.jsxs(ce,{children:[e.jsx(me,{className:"bg-muted/50 dark:bg-dark-muted/50",children:e.jsxs(X,{children:[e.jsx(y,{className:"w-[40px]",children:"#"}),e.jsx(y,{className:"min-w-[200px]",children:"Product/Service"}),e.jsx(y,{className:"w-[100px]",children:"Quantity"}),e.jsx(y,{className:"w-[100px]",children:"Qty Unit"}),e.jsx(y,{className:"w-[120px] text-right",children:"Rate (Billing Unit)"}),e.jsx(y,{className:"w-[100px]",children:"Billing Unit"}),e.jsx(y,{className:"w-[120px] text-right",children:"Total"}),e.jsx(y,{className:"w-[60px] text-center",children:"Actions"})]})}),e.jsx(ue,{children:f.map((t,i)=>{var s,l,n;return console.log("Item:",t),console.log("item.totalPrice:",t.totalPrice),e.jsxs(X,{children:[e.jsx(b,{children:i+1}),e.jsx(b,{children:e.jsxs(k,{value:t.productId,onValueChange:a=>S(t.id,"productId",a),children:[e.jsx(T,{className:"text-sm",children:e.jsx(L,{placeholder:"Select product"})}),e.jsx(O,{children:A.map(a=>e.jsx(E,{value:a.id,children:a.name},a.id))})]})}),e.jsx(b,{children:e.jsx(z,{type:"number",value:t.quantityInput,onChange:a=>S(t.id,"quantityInput",a.target.value),placeholder:"1",className:"w-full text-sm",min:"0",step:"any"})}),e.jsx(b,{children:e.jsxs(k,{value:t.quantityUnitId,onValueChange:a=>S(t.id,"quantityUnitId",a),disabled:!t.productDetails,children:[e.jsx(T,{className:"text-sm",children:e.jsx(L,{placeholder:"Unit"})}),e.jsx(O,{children:((s=t.productDetails)==null?void 0:s.units)&&t.productDetails.units.map(a=>e.jsx(E,{value:a.id,children:a.name},a.id))})]})}),e.jsx(b,{children:e.jsx(z,{type:"number",value:t.rateForBillingUnit,onChange:a=>S(t.id,"rateForBillingUnit",a.target.value),placeholder:"0.00",className:"w-full text-sm",min:"0",step:"0.01"})}),e.jsx(b,{children:e.jsxs(k,{value:t.billingUnitId,onValueChange:a=>S(t.id,"billingUnitId",a),disabled:!t.productDetails,children:[e.jsx(T,{className:"text-sm",children:e.jsx(L,{placeholder:"Unit"})}),e.jsx(O,{children:(n=(l=t.productDetails)==null?void 0:l.units)==null?void 0:n.map(a=>{var g;return e.jsxs(E,{value:a.id,children:[a.name," (",a.factor," ",(g=t.productDetails)==null?void 0:g.baseUnitName,")"]},a.id)})})]})}),e.jsx(b,{className:"text-right font-semibold",children:(t.totalPrice||0).toLocaleString("en-US",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2})}),e.jsx(b,{className:"text-center",children:e.jsx(B,{variant:"ghost",size:"icon",onClick:()=>ae(t.id),children:e.jsx(xe,{size:16,className:"text-destructive"})})})]},t.id)})})]})}),e.jsxs(B,{onClick:te,variant:"outline",className:"mb-8",children:[e.jsx(ge,{size:18,className:"mr-2"})," Add Line Item"]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-6 items-start",children:[e.jsxs("div",{children:[e.jsx(F,{htmlFor:"description",className:"font-semibold",children:"Description / Notes"}),e.jsx(pe,{id:"description",value:J,onChange:t=>V(t.target.value),placeholder:"Add any additional notes or descriptions here...",className:"mt-1 min-h-[100px]"})]}),e.jsx("div",{className:"flex justify-end md:justify-start md:col-start-2",children:e.jsx("div",{className:"w-full md:w-1/2 border-t border-border dark:border-dark-border pt-4",children:e.jsxs("div",{className:"flex justify-between font-bold text-lg",children:[e.jsx("span",{children:"Overall Total:"}),e.jsx("span",{children:(H||0).toLocaleString("en-US",{style:"currency",currency:"USD"})})]})})})]}),e.jsxs("div",{className:"flex justify-end space-x-2 mt-8",children:[e.jsx(B,{variant:"outline",onClick:()=>M(!0),children:"Save Draft"}),e.jsx(B,{onClick:()=>M(!1),children:"Finalize & Print"})]})]})]})})};export{we as default};
