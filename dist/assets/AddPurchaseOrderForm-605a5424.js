import{g as de,r as d,j as e,B as U}from"./index-19c11a3b.js";import{I as T}from"./input-f9c35bba.js";import{L as h}from"./label-02fce936.js";import{D as M}from"./date-picker-effe6807.js";import{S as w,a as C,b as F,c as q,d as g}from"./select-25b0f302.js";import{T as H}from"./textarea-21b2dcf0.js";import{C as ie,a as le,b as oe,c as ce,d as ue}from"./card-f4a39e41.js";import{P as me}from"./package-plus-72bb4fd2.js";import{T as pe}from"./trash-2-c0139f04.js";import{P as xe}from"./plus-circle-fb03b45f.js";import{S as W}from"./save-c186d9d7.js";const he=()=>{const b=localStorage.getItem("vendors");return b?JSON.parse(b):[]},ge=()=>{const b=localStorage.getItem("products");if(b)try{return JSON.parse(b).map(i=>{var f;return{...i,units:((f=i.units)==null?void 0:f.map(j=>({...j,id:j.id||`${i.id}-${j.name}-${Date.now()}`})))||[],openingQuantity:i.isService?1/0:i.openingQuantity||0}})}catch(y){return console.error("Failed to parse products from localStorage",y),[]}return[{id:"PROD001",name:"Standard Widget",costingPrice:15.5,openingQuantity:100,isService:!1,units:[{id:`PROD001-pcs-${Date.now()}`,name:"pcs",factor:1,isBase:!0},{id:`PROD001-dozen-${Date.now()}`,name:"dozen",factor:12,isBase:!1}],baseUnitName:"pcs"}]},Ce=({onSave:b,onCancel:y})=>{const{toast:i}=de(),[f,j]=d.useState(""),[Y,Z]=d.useState([]),[A,G]=d.useState(new Date),[E,K]=d.useState(new Date(new Date().setDate(new Date().getDate()+7))),[P,be]=d.useState(`PO-${String(Date.now()).slice(-6)}`),[L,X]=d.useState(""),[z,O]=d.useState(""),[v,_]=d.useState(null),[Q,ee]=d.useState(""),[$,te]=d.useState([]),[B,re]=d.useState([]),R="Your Company Address, City, State, Zip";d.useEffect(()=>{te(ge());const t=JSON.parse(localStorage.getItem("customers")||"[]");re(t),Z(he())},[]),d.useEffect(()=>{if(v){const t=B.find(s=>s.id===v);t&&O(t.address||"")}else O(R)},[v,B,R]);const[x,V]=d.useState([{id:Date.now(),productId:"",productDetails:null,quantityInput:1,quantityUnitId:"",billingUnitId:"",rateForBillingUnit:0,totalPrice:0}]),ae=d.useCallback(t=>{let s=parseFloat(t.quantityInput)||0;if(t.productDetails&&t.quantityUnitId&&t.productDetails.units){const a=t.productDetails.units.find(r=>r.id===t.quantityUnitId);a&&a.factor>0&&(s=(parseFloat(t.quantityInput)||0)*a.factor)}let n=0;if(t.productDetails&&t.billingUnitId&&t.productDetails.units){const a=t.productDetails.units.find(r=>r.id===t.billingUnitId);if(a&&a.factor>0){const r=(parseFloat(t.rateForBillingUnit)||0)/a.factor;n=s*r}}const u=parseFloat(n.toFixed(2));return{...t,totalPrice:u,itemRawTotal:n}},[]),se=()=>{V([...x,{id:Date.now(),productId:"",productDetails:null,quantityInput:1,quantityUnitId:"",billingUnitId:"",rateForBillingUnit:0,totalPrice:0}])},ne=t=>{V(x.filter(s=>s.id!==t))},k=(t,s,n)=>{V(u=>u.map(a=>{var m,N,I,S,D;if(a.id!==t)return a;let r={...a};if(s==="productId"){const l=$.find(o=>o.id===n);if(l){r.productId=n,r.productDetails=l;const o=(m=l.units)==null?void 0:m.find(p=>p.isBase);if(r.quantityUnitId=o?o.id:((I=(N=l.units)==null?void 0:N[0])==null?void 0:I.id)||"",r.billingUnitId=o?o.id:((D=(S=l.units)==null?void 0:S[0])==null?void 0:D.id)||"",o&&l.costingPrice){const p=l.units.find(c=>c.id===r.billingUnitId);r.rateForBillingUnit=(l.costingPrice||0)*((p==null?void 0:p.factor)||1)}else r.rateForBillingUnit=0;r.quantityInput=1}else r={...r,productId:"",productDetails:null,quantityUnitId:"",billingUnitId:"",rateForBillingUnit:0,quantityInput:1}}else s==="quantityUnitId"||s==="billingUnitId"?r[s]=n:s==="quantityInput"?r.quantityInput=parseFloat(n)>=0?parseFloat(n):0:s==="rateForBillingUnit"?r[s]=parseFloat(n)||0:r[s]=n;return ae(r)}))},J=(t=!1)=>{if(!f){i({title:"Validation Error",description:"Please select a vendor.",variant:"destructive"});return}if(x.some(a=>!a.productId||a.quantityInput===0)){i({title:"Validation Error",description:"Please ensure all line items have a product and valid quantity.",variant:"destructive"});return}if(x.length===0||x.every(a=>a.quantityInput===0)){i({title:"Validation Error",description:"Cannot save an empty order or an order with all zero quantities.",variant:"destructive"});return}const s=x.filter(a=>a.quantityInput>0);if(s.length===0){i({title:"Validation Error",description:"Cannot save an order with no valid line items.",variant:"destructive"});return}const n={vendor:f,orderNumber:P,orderDate:A,expectedDeliveryDate:E,memo:L,shippingAddress:z,dropShipToCustomer:v,lineItems:s.map(a=>{var r,m,N,I,S,D,l,o,p;return{productId:a.productId,productName:(r=a.productDetails)==null?void 0:r.name,quantityInput:a.quantityInput,quantityUnitId:a.quantityUnitId,quantityUnitName:(N=(m=a.productDetails)==null?void 0:m.units.find(c=>c.id===a.quantityUnitId))==null?void 0:N.name,quantityUnitFactor:(S=(I=a.productDetails)==null?void 0:I.units.find(c=>c.id===a.quantityUnitId))==null?void 0:S.factor,billingUnitId:a.billingUnitId,billingUnitName:(l=(D=a.productDetails)==null?void 0:D.units.find(c=>c.id===a.billingUnitId))==null?void 0:l.name,billingUnitFactor:(p=(o=a.productDetails)==null?void 0:o.units.find(c=>c.id===a.billingUnitId))==null?void 0:p.factor,rateForBillingUnit:a.rateForBillingUnit,totalPrice:a.totalPrice}}),notes:Q,isDraft:t};console.log("Purchase Order Data: ",JSON.stringify(n,null,2));const u=JSON.parse(localStorage.getItem("purchaseOrders")||"[]");localStorage.setItem("purchaseOrders",JSON.stringify([...u,n])),i({title:"Purchase Order Saved",description:`Order ${P} has been ${t?"saved as draft":"saved"}.`,className:"bg-green-100 dark:bg-green-800 text-green-700 dark:text-green-200 border-green-300 dark:border-green-600"}),y()};return e.jsx("div",{className:"space-y-6 p-1 md:p-2",children:e.jsxs(ie,{className:"shadow-xl border-border dark:border-dark-border bg-card dark:bg-dark-card",children:[e.jsx(le,{className:"p-6 border-b border-border dark:border-dark-border",children:e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs(oe,{className:"text-3xl font-bold text-primary dark:text-dark-primary flex items-center",children:[e.jsx(me,{size:32,className:"mr-3 text-accent dark:text-dark-accent"})," New Purchase Order"]}),e.jsx("div",{className:"text-muted-foreground dark:text-dark-muted-foreground font-mono text-sm bg-muted dark:bg-dark-muted px-2 py-1 rounded self-start sm:self-center",children:P})]})}),e.jsxs(ce,{className:"p-6 space-y-8",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(h,{htmlFor:"vendor",className:"font-semibold",children:["Vendor ",e.jsx("span",{className:"text-destructive dark:text-red-400",children:"*"})]}),e.jsxs(w,{onValueChange:j,value:f,children:[e.jsx(C,{id:"vendor",children:e.jsx(F,{placeholder:"Select vendor"})}),e.jsx(q,{children:Y.map(t=>e.jsx(g,{value:t.id,children:t.name},t.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"orderDate",className:"font-semibold",children:"Order Date"}),e.jsx(M,{date:A,setDate:G})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"expectedDeliveryDate",className:"font-semibold",children:"Expected Delivery Date"}),e.jsx(M,{date:E,setDate:K})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"memo",className:"font-semibold",children:"Memo"}),e.jsx(T,{id:"memo",value:L,onChange:t=>X(t.target.value),placeholder:"e.g., For Q3 Marketing Campaign"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"dropShipTo",children:"Drop Ship To (Customer)"}),e.jsxs(w,{onValueChange:_,value:v,children:[e.jsx(C,{id:"dropShipTo",children:e.jsx(F,{placeholder:"Select customer (optional)"})}),e.jsxs(q,{children:[e.jsx(g,{value:null,children:"None"}),B.map(t=>e.jsx(g,{value:t.id,children:t.name},t.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"shippingAddress",className:"font-semibold",children:"Shipping Address"}),e.jsx(H,{id:"shippingAddress",value:z,onChange:t=>O(t.target.value),placeholder:"Enter shipping address",className:"min-h-[100px]"})]})]}),e.jsxs("div",{className:"overflow-x-auto bg-background dark:bg-dark-background p-4 rounded-lg border border-border dark:border-dark-border shadow-inner",children:[e.jsxs("table",{className:"w-full min-w-[1000px]",children:[e.jsx("thead",{className:"border-b-2 border-primary dark:border-dark-primary",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[20%]",children:"Product/Service"}),e.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[10%]",children:"Quantity"}),e.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[10%]",children:"Qty Unit"}),e.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[15%]",children:"Rate (Billing Unit)"}),e.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[15%]",children:"Billing Unit"}),e.jsx("th",{className:"p-3 text-right text-sm font-semibold text-primary dark:text-dark-primary w-[15%]",children:"Total"}),e.jsx("th",{className:"p-3 text-center text-sm font-semibold text-primary dark:text-dark-primary w-[5%"})]})}),e.jsx("tbody",{children:x.map(t=>{var s,n,u,a;return e.jsxs("tr",{className:"border-b border-border dark:border-dark-border last:border-b-0 hover:bg-muted/50 dark:hover:bg-dark-muted/50 transition-colors",children:[e.jsx("td",{className:"p-2",children:e.jsxs(w,{value:t.productId,onValueChange:r=>k(t.id,"productId",r),children:[e.jsx(C,{className:"text-sm",children:e.jsx(F,{placeholder:"Select product"})}),e.jsxs(q,{children:[e.jsx(g,{value:null,children:"Select product"}),$.map(r=>e.jsx(g,{value:r.id,children:r.name},r.id))]})]})}),e.jsx("td",{className:"p-2",children:e.jsx(T,{type:"number",value:t.quantityInput,onChange:r=>k(t.id,"quantityInput",r.target.value),placeholder:"1",className:"w-full text-sm",min:"0",step:"any"})}),e.jsx("td",{className:"p-2",children:e.jsxs(w,{value:t.quantityUnitId,onValueChange:r=>k(t.id,"quantityUnitId",r),disabled:!t.productDetails,children:[e.jsx(C,{className:"text-sm",children:e.jsx(F,{placeholder:"Unit"})}),e.jsx(q,{children:(n=(s=t.productDetails)==null?void 0:s.units)==null?void 0:n.map(r=>e.jsx(g,{value:r.id,children:r.name},r.id))})]})}),e.jsx("td",{className:"p-2",children:e.jsx(T,{type:"number",value:t.rateForBillingUnit,onChange:r=>k(t.id,"rateForBillingUnit",r.target.value),placeholder:"0.00",className:"w-full text-sm",min:"0",step:"0.01"})}),e.jsx("td",{className:"p-2",children:e.jsxs(w,{value:t.billingUnitId,onValueChange:r=>k(t.id,"billingUnitId",r),disabled:!t.productDetails,children:[e.jsx(C,{className:"text-sm",children:e.jsx(F,{placeholder:"Unit"})}),e.jsx(q,{children:(a=(u=t.productDetails)==null?void 0:u.units)==null?void 0:a.map(r=>{var m;return e.jsxs(g,{value:r.id,children:[r.name," (",r.factor," ",(m=t.productDetails)==null?void 0:m.baseUnitName,")"]},r.id)})})]})}),e.jsx("td",{className:"p-2 text-right text-sm font-medium",children:(t.totalPrice||0).toLocaleString("en-US",{style:"currency",currency:"USD"})}),e.jsx("td",{className:"p-2 text-center",children:e.jsx(U,{variant:"ghost",size:"icon",onClick:()=>ne(t.id),className:"text-destructive dark:text-red-400 hover:text-destructive/80 h-8 w-8",children:e.jsx(pe,{size:16})})})]},t.id)})})]}),e.jsxs(U,{onClick:se,variant:"outline",className:"mt-4 text-accent dark:text-dark-accent border-accent dark:border-dark-accent hover:bg-accent/10 dark:hover:bg-dark-accent/10 shadow-sm",children:[e.jsx(xe,{size:18,className:"mr-2"})," Add Line Item"]})]}),e.jsx("div",{className:"grid md:grid-cols-2 gap-6 items-start",children:e.jsxs("div",{children:[e.jsx(h,{htmlFor:"notes",className:"font-semibold",children:"Notes/Remarks"}),e.jsx(H,{id:"notes",value:Q,onChange:t=>ee(t.target.value),placeholder:"Enter any notes or remarks for this bill...",className:"mt-1 min-h-[100px]"})]})})]}),e.jsxs(ue,{className:"bg-muted/30 dark:bg-dark-muted/30 rounded-b-lg p-6 flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-3 border-t border-border dark:border-dark-border",children:[e.jsx(U,{variant:"outline",className:"w-full sm:w-auto",onClick:y,children:"Cancel"}),e.jsxs(U,{className:"w-full sm:w-auto bg-secondary text-secondary-foreground hover:bg-secondary-hover dark:bg-dark-secondary dark:text-dark-secondary-foreground dark:hover:bg-dark-secondary-hover flex items-center shadow hover:shadow-md",onClick:()=>J(!0),children:[e.jsx(W,{size:18,className:"mr-2"})," Save as Draft"]}),e.jsxs(U,{className:"w-full sm:w-auto bg-primary text-primary-foreground hover:bg-primary-hover dark:bg-dark-primary dark:text-dark-primary-foreground dark:hover:bg-dark-primary-hover flex items-center shadow hover:shadow-md",onClick:()=>J(!1),children:[e.jsx(W,{size:18,className:"mr-2"})," Save Order"]})]})]})})};export{Ce as A};
